# æ˜¾ç¤ºé…ç½®æ•…éšœæŽ’é™¤æŒ‡å—

## ðŸš¨ å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³

### é—®é¢˜1ï¼šRDPè¿žæŽ¥æ˜¾ç¤ºæ¨¡ç³Š
**ç—‡çŠ¶æè¿°**ï¼š
- è¿œç¨‹æ¡Œé¢æ–‡å­—æ¨¡ç³Šä¸æ¸…
- å›¾æ ‡å’Œç•Œé¢å…ƒç´ æ˜¾ç¤ºä¸æ¸…æ™°
- æ•´ä½“ç”»é¢ç¼ºä¹é”åº¦

**å¯èƒ½åŽŸå› **ï¼š
- HiDPIæ˜¾ç¤ºå™¨ç¼©æ”¾è®¾ç½®ä¸åŒ¹é…
- Microsoft Remote Desktopç‰ˆæœ¬è¿‡æ—§
- æ˜¾ç¤ºä¼˜åŒ–æœªæ­£ç¡®åº”ç”¨

**è§£å†³æ­¥éª¤**ï¼š
1. **æ£€æŸ¥Remote Desktopç‰ˆæœ¬**
   ```bash
   # æ£€æŸ¥æ˜¯å¦ä¸ºæœ€æ–°ç‰ˆæœ¬
   open -a "Microsoft Remote Desktop"
   # èœå• -> Microsoft Remote Desktop -> About
   ```

2. **éªŒè¯æ˜¾ç¤ºä¼˜åŒ–æ˜¯å¦ç”Ÿæ•ˆ**
   - é‡æ–°ç‚¹å‡»RDPè¿žæŽ¥é“¾æŽ¥
   - è§‚å¯Ÿæ˜¯å¦æœ‰"æ˜¾ç¤ºä¼˜åŒ–"ç›¸å…³é€šçŸ¥
   - æ£€æŸ¥ç”Ÿæˆçš„RDPæ–‡ä»¶æ˜¯å¦åŒ…å«ä¼˜åŒ–å‚æ•°

3. **æ‰‹åŠ¨é‡ç½®æ˜¾ç¤ºæ£€æµ‹**
   ```bash
   # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   rm -rf ~/Library/Caches/com.jms.protocolhandler
   # é‡å¯åº”ç”¨ç¨‹åº
   killall JMSProtocolHandler
   ```

### é—®é¢˜2ï¼šæ˜¾ç¤ºå™¨æ£€æµ‹å¤±è´¥
**ç—‡çŠ¶æè¿°**ï¼š
- åº”ç”¨ç¨‹åºæ˜¾ç¤º"æ˜¾ç¤ºå™¨æ£€æµ‹å¤±è´¥"é”™è¯¯
- RDPè¿žæŽ¥ä½¿ç”¨é»˜è®¤çš„ä½Žåˆ†è¾¨çŽ‡è®¾ç½®
- æ— æ³•èŽ·å–æ˜¾ç¤ºå™¨ä¿¡æ¯

**è¯Šæ–­æ­¥éª¤**ï¼š
1. **æ£€æŸ¥ç³»ç»Ÿæƒé™**
   ```bash
   # æ£€æŸ¥åº”ç”¨ç¨‹åºæ˜¯å¦æœ‰å±å¹•å½•åˆ¶æƒé™
   # ç³»ç»Ÿåå¥½è®¾ç½® -> å®‰å…¨æ€§ä¸Žéšç§ -> éšç§ -> å±å¹•å½•åˆ¶
   ```

2. **è¿è¡Œæ˜¾ç¤ºæ£€æµ‹æµ‹è¯•**
   ```bash
   # åˆ›å»ºæµ‹è¯•è„šæœ¬
   cat > test_display.sh << 'EOF'
   #!/bin/bash
   echo "æ£€æµ‹æ˜¾ç¤ºå™¨é…ç½®..."
   system_profiler SPDisplaysDataType
   EOF
   chmod +x test_display.sh
   ./test_display.sh
   ```

3. **é‡æ–°æŽˆæƒåº”ç”¨ç¨‹åº**
   - ç³»ç»Ÿåå¥½è®¾ç½® -> å®‰å…¨æ€§ä¸Žéšç§ -> éšç§
   - æ·»åŠ JMSProtocolHandleråˆ°å±å¹•å½•åˆ¶æƒé™åˆ—è¡¨

### é—®é¢˜3ï¼šå¤šæ˜¾ç¤ºå™¨çŽ¯å¢ƒé…ç½®é”™è¯¯
**ç—‡çŠ¶æè¿°**ï¼š
- åœ¨å¤šæ˜¾ç¤ºå™¨çŽ¯å¢ƒä¸‹RDPè¿žæŽ¥æ˜¾ç¤ºå¼‚å¸¸
- åˆ†è¾¨çŽ‡é€‰æ‹©ä¸æ­£ç¡®
- ä¸»æ˜¾ç¤ºå™¨è¯†åˆ«é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **æ£€æŸ¥æ˜¾ç¤ºå™¨æŽ’åˆ—**
   ```bash
   # ç³»ç»Ÿåå¥½è®¾ç½® -> æ˜¾ç¤ºå™¨ -> æŽ’åˆ—
   # ç¡®ä¿ä¸»æ˜¾ç¤ºå™¨è®¾ç½®æ­£ç¡®ï¼ˆç™½è‰²èœå•æ ï¼‰
   ```

2. **é‡æ–°æ£€æµ‹æ˜¾ç¤ºå™¨**
   - æ–­å¼€å¹¶é‡æ–°è¿žæŽ¥å¤–æŽ¥æ˜¾ç¤ºå™¨
   - é‡å¯JMS Protocol Handler
   - é‡æ–°ç‚¹å‡»RDPè¿žæŽ¥é“¾æŽ¥

3. **æ‰‹åŠ¨æŒ‡å®šä¸»æ˜¾ç¤ºå™¨**
   - åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­é‡æ–°è®¾ç½®ä¸»æ˜¾ç¤ºå™¨
   - é‡å¯åº”ç”¨ç¨‹åº

### é—®é¢˜4ï¼šæ€§èƒ½é—®é¢˜
**ç—‡çŠ¶æè¿°**ï¼š
- æ˜¾ç¤ºä¼˜åŒ–è¿‡ç¨‹è€—æ—¶è¿‡é•¿
- åº”ç”¨ç¨‹åºå“åº”ç¼“æ…¢
- ç³»ç»Ÿèµ„æºå ç”¨è¿‡é«˜

**æ€§èƒ½ä¼˜åŒ–**ï¼š
1. **æ£€æŸ¥ç³»ç»Ÿèµ„æº**
   ```bash
   # æ£€æŸ¥CPUå’Œå†…å­˜ä½¿ç”¨
   top -pid $(pgrep JMSProtocolHandler)
   ```

2. **æ¸…ç†ç¼“å­˜æ–‡ä»¶**
   ```bash
   # æ¸…ç†åº”ç”¨ç¨‹åºç¼“å­˜
   rm -rf ~/Library/Caches/com.jms.protocolhandler/*
   ```

3. **é‡å¯ç›¸å…³æœåŠ¡**
   ```bash
   # é‡å¯çª—å£æœåŠ¡å™¨ï¼ˆéœ€è¦é‡æ–°ç™»å½•ï¼‰
   sudo killall -HUP WindowServer
   ```

## ðŸ”§ é«˜çº§æ•…éšœæŽ’é™¤

### æ—¥å¿—åˆ†æž
**æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**ï¼š
```bash
# æŸ¥çœ‹åº”ç”¨ç¨‹åºæ—¥å¿—
log show --predicate 'subsystem == "com.jms.protocolhandler"' --last 1h --info

# æŸ¥çœ‹æ˜¾ç¤ºç›¸å…³æ—¥å¿—
log show --predicate 'category == "display"' --last 30m
```

**å¸¸è§æ—¥å¿—æ¶ˆæ¯**ï¼š
- `Display detection started`: æ˜¾ç¤ºå™¨æ£€æµ‹å¼€å§‹
- `Display optimization completed`: æ˜¾ç¤ºä¼˜åŒ–å®Œæˆ
- `RDP config generated`: RDPé…ç½®ç”ŸæˆæˆåŠŸ
- `Display detection failed`: æ˜¾ç¤ºå™¨æ£€æµ‹å¤±è´¥

### æ‰‹åŠ¨é…ç½®éªŒè¯
**åˆ›å»ºæµ‹è¯•RDPæ–‡ä»¶**ï¼š
```bash
cat > test_connection.rdp << 'EOF'
full address:s:test.example.com:3389
username:s:testuser
desktopwidth:i:1920
desktopheight:i:1080
session bpp:i:24
desktopscalefactor:i:100
smart sizing:i:1
compression:i:1
EOF

# ä½¿ç”¨Remote Desktopæ‰“å¼€æµ‹è¯•æ–‡ä»¶
open test_connection.rdp
```

### ç³»ç»Ÿå…¼å®¹æ€§æ£€æŸ¥
**æ£€æŸ¥macOSç‰ˆæœ¬å…¼å®¹æ€§**ï¼š
```bash
# æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬
sw_vers

# æ£€æŸ¥æ”¯æŒçš„æœ€ä½Žç‰ˆæœ¬
# JMS Protocol Handler è¦æ±‚ macOS 10.15+
```

**æ£€æŸ¥ç¡¬ä»¶å…¼å®¹æ€§**ï¼š
```bash
# æ£€æŸ¥æ˜¾å¡ä¿¡æ¯
system_profiler SPDisplaysDataType | grep -A 5 "Graphics/Displays"

# æ£€æŸ¥å¤„ç†å™¨æž¶æž„
uname -m
```

## ðŸ› ï¸ è¯Šæ–­å·¥å…·

### è‡ªåŠ¨è¯Šæ–­è„šæœ¬
åˆ›å»ºè‡ªåŠ¨è¯Šæ–­è„šæœ¬ï¼š
```bash
cat > diagnose_display.sh << 'EOF'
#!/bin/bash
echo "=== JMS Protocol Handler æ˜¾ç¤ºé…ç½®è¯Šæ–­ ==="
echo

echo "1. ç³»ç»Ÿä¿¡æ¯ï¼š"
sw_vers
echo

echo "2. æ˜¾ç¤ºå™¨é…ç½®ï¼š"
system_profiler SPDisplaysDataType | grep -E "(Resolution|UI Looks like|Retina)"
echo

echo "3. åº”ç”¨ç¨‹åºçŠ¶æ€ï¼š"
ps aux | grep JMSProtocolHandler | grep -v grep
echo

echo "4. æƒé™æ£€æŸ¥ï¼š"
ls -la ~/Library/Caches/com.jms.protocolhandler/ 2>/dev/null || echo "ç¼“å­˜ç›®å½•ä¸å­˜åœ¨"
echo

echo "5. æœ€è¿‘é”™è¯¯æ—¥å¿—ï¼š"
log show --predicate 'subsystem == "com.jms.protocolhandler"' --last 10m --style compact | tail -10
echo

echo "=== è¯Šæ–­å®Œæˆ ==="
EOF

chmod +x diagnose_display.sh
./diagnose_display.sh
```

### æ€§èƒ½æµ‹è¯•å·¥å…·
```bash
cat > performance_test.sh << 'EOF'
#!/bin/bash
echo "=== æ˜¾ç¤ºä¼˜åŒ–æ€§èƒ½æµ‹è¯• ==="

# æµ‹è¯•æ˜¾ç¤ºå™¨æ£€æµ‹é€Ÿåº¦
echo "æµ‹è¯•æ˜¾ç¤ºå™¨æ£€æµ‹æ€§èƒ½..."
time system_profiler SPDisplaysDataType > /dev/null

# æµ‹è¯•RDPæ–‡ä»¶ç”Ÿæˆé€Ÿåº¦
echo "æµ‹è¯•RDPé…ç½®ç”Ÿæˆæ€§èƒ½..."
start_time=$(date +%s.%N)
for i in {1..100}; do
    cat > temp_$i.rdp << 'RDPEOF'
full address:s:test.example.com:3389
username:s:testuser
desktopwidth:i:1920
desktopheight:i:1080
RDPEOF
done
end_time=$(date +%s.%N)
duration=$(echo "$end_time - $start_time" | bc)
echo "ç”Ÿæˆ100ä¸ªRDPæ–‡ä»¶è€—æ—¶: ${duration}ç§’"

# æ¸…ç†æµ‹è¯•æ–‡ä»¶
rm -f temp_*.rdp

echo "=== æ€§èƒ½æµ‹è¯•å®Œæˆ ==="
EOF

chmod +x performance_test.sh
./performance_test.sh
```

## ðŸ“‹ é—®é¢˜æŠ¥å‘Šæ¨¡æ¿

å½“æ‚¨é‡åˆ°æ— æ³•è§£å†³çš„é—®é¢˜æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿æŠ¥å‘Šé—®é¢˜ï¼š

```
### é—®é¢˜æè¿°
[è¯¦ç»†æè¿°é‡åˆ°çš„é—®é¢˜]

### ç³»ç»ŸçŽ¯å¢ƒ
- macOSç‰ˆæœ¬ï¼š[ä¾‹å¦‚ macOS 13.0]
- ç¡¬ä»¶åž‹å·ï¼š[ä¾‹å¦‚ MacBook Pro 16" 2023]
- æ˜¾ç¤ºå™¨é…ç½®ï¼š[ä¾‹å¦‚ å†…ç½®Retina + å¤–æŽ¥4Kæ˜¾ç¤ºå™¨]
- Remote Desktopç‰ˆæœ¬ï¼š[ä¾‹å¦‚ 10.8.0]

### é‡çŽ°æ­¥éª¤
1. [æ­¥éª¤1]
2. [æ­¥éª¤2]
3. [æ­¥éª¤3]

### é¢„æœŸç»“æžœ
[æè¿°æœŸæœ›çš„æ­£ç¡®è¡Œä¸º]

### å®žé™…ç»“æžœ
[æè¿°å®žé™…å‘ç”Ÿçš„æƒ…å†µ]

### è¯Šæ–­ä¿¡æ¯
[ç²˜è´´ diagnose_display.sh çš„è¾“å‡ºç»“æžœ]

### é”™è¯¯æ—¥å¿—
[ç²˜è´´ç›¸å…³çš„é”™è¯¯æ—¥å¿—]
```

## ðŸ”„ æ¢å¤æ­¥éª¤

### å®Œå…¨é‡ç½®åº”ç”¨ç¨‹åº
å¦‚æžœæ‰€æœ‰æ•…éšœæŽ’é™¤æ­¥éª¤éƒ½æ— æ•ˆï¼Œå¯ä»¥å®Œå…¨é‡ç½®åº”ç”¨ç¨‹åºï¼š

```bash
# 1. åœæ­¢åº”ç”¨ç¨‹åº
killall JMSProtocolHandler

# 2. åˆ é™¤æ‰€æœ‰ç›¸å…³æ–‡ä»¶
rm -rf ~/Library/Caches/com.jms.protocolhandler/
rm -rf ~/Library/Preferences/com.jms.protocolhandler.plist
rm -rf ~/Library/Application\ Support/JMSProtocolHandler/

# 3. é‡æ–°å®‰è£…åº”ç”¨ç¨‹åº
# ä»ŽDMGæ–‡ä»¶é‡æ–°å®‰è£…

# 4. é‡æ–°æ³¨å†Œåè®®
./scripts/deployment/register_jms_protocol.sh

# 5. æµ‹è¯•åŠŸèƒ½
./scripts/test/test_jms_protocol.sh
```

### å¤‡ç”¨é…ç½®
å¦‚æžœæ˜¾ç¤ºä¼˜åŒ–åŠŸèƒ½å®Œå…¨æ— æ³•å·¥ä½œï¼Œåº”ç”¨ç¨‹åºä¼šè‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨é…ç½®ï¼š
- åˆ†è¾¨çŽ‡ï¼š1920Ã—1080
- é¢œè‰²æ·±åº¦ï¼š24ä½
- åŽ‹ç¼©ï¼šé€‚åº¦åŽ‹ç¼©
- ç¼©æ”¾ï¼š100%

è¿™ç¡®ä¿å³ä½¿åœ¨æ˜¾ç¤ºä¼˜åŒ–å¤±è´¥çš„æƒ…å†µä¸‹ï¼ŒRDPè¿žæŽ¥ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

---

**å¦‚æžœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·é€šè¿‡GitHub Issuesè”ç³»æˆ‘ä»¬èŽ·å–è¿›ä¸€æ­¥æ”¯æŒã€‚** ðŸ†˜
