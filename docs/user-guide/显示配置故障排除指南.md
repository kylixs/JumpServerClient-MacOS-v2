# 显示配置故障排除指南

## 🚨 常见问题快速解决

### 问题1：RDP连接显示模糊
**症状描述**：
- 远程桌面文字模糊不清
- 图标和界面元素显示不清晰
- 整体画面缺乏锐度

**可能原因**：
- HiDPI显示器缩放设置不匹配
- Microsoft Remote Desktop版本过旧
- 显示优化未正确应用

**解决步骤**：
1. **检查Remote Desktop版本**
   ```bash
   # 检查是否为最新版本
   open -a "Microsoft Remote Desktop"
   # 菜单 -> Microsoft Remote Desktop -> About
   ```

2. **验证显示优化是否生效**
   - 重新点击RDP连接链接
   - 观察是否有"显示优化"相关通知
   - 检查生成的RDP文件是否包含优化参数

3. **手动重置显示检测**
   ```bash
   # 清理临时文件
   rm -rf ~/Library/Caches/com.jms.protocolhandler
   # 重启应用程序
   killall JMSProtocolHandler
   ```

### 问题2：显示器检测失败
**症状描述**：
- 应用程序显示"显示器检测失败"错误
- RDP连接使用默认的低分辨率设置
- 无法获取显示器信息

**诊断步骤**：
1. **检查系统权限**
   ```bash
   # 检查应用程序是否有屏幕录制权限
   # 系统偏好设置 -> 安全性与隐私 -> 隐私 -> 屏幕录制
   ```

2. **运行显示检测测试**
   ```bash
   # 创建测试脚本
   cat > test_display.sh << 'EOF'
   #!/bin/bash
   echo "检测显示器配置..."
   system_profiler SPDisplaysDataType
   EOF
   chmod +x test_display.sh
   ./test_display.sh
   ```

3. **重新授权应用程序**
   - 系统偏好设置 -> 安全性与隐私 -> 隐私
   - 添加JMSProtocolHandler到屏幕录制权限列表

### 问题3：多显示器环境配置错误
**症状描述**：
- 在多显示器环境下RDP连接显示异常
- 分辨率选择不正确
- 主显示器识别错误

**解决方案**：
1. **检查显示器排列**
   ```bash
   # 系统偏好设置 -> 显示器 -> 排列
   # 确保主显示器设置正确（白色菜单栏）
   ```

2. **重新检测显示器**
   - 断开并重新连接外接显示器
   - 重启JMS Protocol Handler
   - 重新点击RDP连接链接

3. **手动指定主显示器**
   - 在系统偏好设置中重新设置主显示器
   - 重启应用程序

### 问题4：性能问题
**症状描述**：
- 显示优化过程耗时过长
- 应用程序响应缓慢
- 系统资源占用过高

**性能优化**：
1. **检查系统资源**
   ```bash
   # 检查CPU和内存使用
   top -pid $(pgrep JMSProtocolHandler)
   ```

2. **清理缓存文件**
   ```bash
   # 清理应用程序缓存
   rm -rf ~/Library/Caches/com.jms.protocolhandler/*
   ```

3. **重启相关服务**
   ```bash
   # 重启窗口服务器（需要重新登录）
   sudo killall -HUP WindowServer
   ```

## 🔧 高级故障排除

### 日志分析
**查看详细日志**：
```bash
# 查看应用程序日志
log show --predicate 'subsystem == "com.jms.protocolhandler"' --last 1h --info

# 查看显示相关日志
log show --predicate 'category == "display"' --last 30m
```

**常见日志消息**：
- `Display detection started`: 显示器检测开始
- `Display optimization completed`: 显示优化完成
- `RDP config generated`: RDP配置生成成功
- `Display detection failed`: 显示器检测失败

### 手动配置验证
**创建测试RDP文件**：
```bash
cat > test_connection.rdp << 'EOF'
full address:s:test.example.com:3389
username:s:testuser
desktopwidth:i:1920
desktopheight:i:1080
session bpp:i:24
desktopscalefactor:i:100
smart sizing:i:1
compression:i:1
EOF

# 使用Remote Desktop打开测试文件
open test_connection.rdp
```

### 系统兼容性检查
**检查macOS版本兼容性**：
```bash
# 检查系统版本
sw_vers

# 检查支持的最低版本
# JMS Protocol Handler 要求 macOS 10.15+
```

**检查硬件兼容性**：
```bash
# 检查显卡信息
system_profiler SPDisplaysDataType | grep -A 5 "Graphics/Displays"

# 检查处理器架构
uname -m
```

## 🛠️ 诊断工具

### 自动诊断脚本
创建自动诊断脚本：
```bash
cat > diagnose_display.sh << 'EOF'
#!/bin/bash
echo "=== JMS Protocol Handler 显示配置诊断 ==="
echo

echo "1. 系统信息："
sw_vers
echo

echo "2. 显示器配置："
system_profiler SPDisplaysDataType | grep -E "(Resolution|UI Looks like|Retina)"
echo

echo "3. 应用程序状态："
ps aux | grep JMSProtocolHandler | grep -v grep
echo

echo "4. 权限检查："
ls -la ~/Library/Caches/com.jms.protocolhandler/ 2>/dev/null || echo "缓存目录不存在"
echo

echo "5. 最近错误日志："
log show --predicate 'subsystem == "com.jms.protocolhandler"' --last 10m --style compact | tail -10
echo

echo "=== 诊断完成 ==="
EOF

chmod +x diagnose_display.sh
./diagnose_display.sh
```

### 性能测试工具
```bash
cat > performance_test.sh << 'EOF'
#!/bin/bash
echo "=== 显示优化性能测试 ==="

# 测试显示器检测速度
echo "测试显示器检测性能..."
time system_profiler SPDisplaysDataType > /dev/null

# 测试RDP文件生成速度
echo "测试RDP配置生成性能..."
start_time=$(date +%s.%N)
for i in {1..100}; do
    cat > temp_$i.rdp << 'RDPEOF'
full address:s:test.example.com:3389
username:s:testuser
desktopwidth:i:1920
desktopheight:i:1080
RDPEOF
done
end_time=$(date +%s.%N)
duration=$(echo "$end_time - $start_time" | bc)
echo "生成100个RDP文件耗时: ${duration}秒"

# 清理测试文件
rm -f temp_*.rdp

echo "=== 性能测试完成 ==="
EOF

chmod +x performance_test.sh
./performance_test.sh
```

## 📋 问题报告模板

当您遇到无法解决的问题时，请使用以下模板报告问题：

```
### 问题描述
[详细描述遇到的问题]

### 系统环境
- macOS版本：[例如 macOS 13.0]
- 硬件型号：[例如 MacBook Pro 16" 2023]
- 显示器配置：[例如 内置Retina + 外接4K显示器]
- Remote Desktop版本：[例如 10.8.0]

### 重现步骤
1. [步骤1]
2. [步骤2]
3. [步骤3]

### 预期结果
[描述期望的正确行为]

### 实际结果
[描述实际发生的情况]

### 诊断信息
[粘贴 diagnose_display.sh 的输出结果]

### 错误日志
[粘贴相关的错误日志]
```

## 🔄 恢复步骤

### 完全重置应用程序
如果所有故障排除步骤都无效，可以完全重置应用程序：

```bash
# 1. 停止应用程序
killall JMSProtocolHandler

# 2. 删除所有相关文件
rm -rf ~/Library/Caches/com.jms.protocolhandler/
rm -rf ~/Library/Preferences/com.jms.protocolhandler.plist
rm -rf ~/Library/Application\ Support/JMSProtocolHandler/

# 3. 重新安装应用程序
# 从DMG文件重新安装

# 4. 重新注册协议
./scripts/deployment/register_jms_protocol.sh

# 5. 测试功能
./scripts/test/test_jms_protocol.sh
```

### 备用配置
如果显示优化功能完全无法工作，应用程序会自动使用备用配置：
- 分辨率：1920×1080
- 颜色深度：24位
- 压缩：适度压缩
- 缩放：100%

这确保即使在显示优化失败的情况下，RDP连接仍然可以正常工作。

---

**如果问题仍然存在，请通过GitHub Issues联系我们获取进一步支持。** 🆘
